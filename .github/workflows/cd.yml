name: CI

on:
  push:
    branches:
      - 'a5p2'

jobs:
  build:
    runs-on: ubuntu-24.04-arm 
    container:
      image: ghcr.io/wp732/citool:latest
      options: --user root
      env:
        HOME: /home/user
        POETRY_VIRTUALENVS_PATH: /home/user/.cache/pypoetry/virtualenvs
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    permissions:
      contents: write   # needed to upload release assets
      id-token: write   # needed for cosign keyless signing
      packages: read    # needed to pull container from ghcr.io

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Create temporary .git workspace needed by poetry dynamic versioning
        run: git worktree add packages/wp732-rekor-tools

      - name: Prep Poetry
        run: poetry add -D ./packages/wp732-rekor-tools

      - name: Build
        run: bin/build.sh

#      - name: Install Cosign
#        uses: sigstore/cosign-installer@v4.0.0
#        with:
#          cosign-release: 'v3.0.2'
#
#      - name: Cosign attest of whl with embedded SBOM
#        run: bin/whl_create_attest.sh < /dev/null
#        env:
#          GITHUB_ACTIONS: "true"  # needed to disable cosign interactive mode
